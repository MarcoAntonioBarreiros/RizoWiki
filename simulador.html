<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Simulador de Viabilidade – Modelo 3 Cenários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    }

    .glass {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(16px);
    }

    .ring-bg {
      stroke: rgba(148, 163, 184, 0.3);
    }

    .ring-fg {
      stroke-linecap: round;
      transition: stroke-dashoffset 0.6s ease-out, stroke 0.3s ease-out;
    }

    input[type=range] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
      outline: none;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
      cursor: pointer;
      margin-top: -6px;
    }

    input[type=range]::-moz-range-thumb {
      height: 16px;
      width: 16px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.7);
      cursor: pointer;
    }

    .pill {
      border-radius: 999px;
    }

    .sup-exp {
      position: relative;
      top: -0.3em;
    }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen flex items-center justify-center p-4">
  <div class="max-w-6xl w-full space-y-6">
    <!-- Cabeçalho -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
          Simulador de Viabilidade de Inoculantes
        </h1>
        <p class="text-sm text-slate-400 max-w-2xl">
          Modelo conceitual com três faixas de cenário (ideal, intermediário e extremo),
          alinhado à ideia de perda logarítmica de dose (10¹² → 10⁴).
          Use para testar se a lógica de resposta está coerente com o storytelling dos painéis.
        </p>
      </div>
      <div class="text-xs text-slate-400">
        <p><span class="font-semibold text-emerald-400">Verde</span>: janela segura</p>
        <p><span class="font-semibold text-amber-400">Amarelo</span>: atenção / instável</p>
        <p><span class="font-semibold text-red-400">Vermelho</span>: risco alto de perda de dose</p>
      </div>
    </header>

    <!-- Linha principal: controles + gauge -->
    <div class="grid lg:grid-cols-2 gap-6 items-stretch">
      <!-- Controles -->
      <section class="glass rounded-2xl p-5 space-y-4">
        <!-- Organismo -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <div>
            <div class="text-[11px] uppercase tracking-[0.2em] text-emerald-400 font-semibold">
              Organismo alvo
            </div>
            <p class="text-xs text-slate-400 max-w-sm">
              Cada grupo responde de forma diferente ao estresse de tempo, temperatura e mistura química.
            </p>
          </div>
          <select id="organismSelect"
            class="bg-slate-900 text-slate-50 text-sm px-3 py-2 rounded-lg border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="bacillus">Bacillus (esporos)</option>
            <option value="brady">Bradyrhizobium (soja)</option>
            <option value="azo">Azospirillum (vegetativa)</option>
            <option value="pseudomonas">Pseudomonas</option>
            <option value="methylobacterium">Methylobacterium</option>
            <option value="pnsb">PNSB (Bactérias Púrpuras)</option>
            <option value="trichoderma">Trichoderma</option>
            <option value="beauveria">Beauveria bassiana</option>
            <option value="micorrizas">Micorrizas (AMF)</option>
          </select>
        </div>

        <!-- Sliders -->
        <div class="space-y-4">
          <!-- Tempo -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-sky-400 font-semibold">
                Tempo no tanque / preparo (h)
              </div>
              <div id="timeLabel" class="text-xs font-mono bg-slate-900 px-2 py-0.5 rounded pill">
                0 h
              </div>
            </div>
            <input type="range" id="sliderTime" min="0" max="24" step="1" value="0" />
            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
              <span>Aplicação imediata</span>
              <span>24 h de espera</span>
            </div>
          </div>

          <!-- Temperatura -->
          <div>
            <div class="flex items-center justify-between mb-1">
              <div class="text-[10px] uppercase tracking-[0.2em] text-amber-400 font-semibold">
                Temperatura da calda (°C)
              </div>
              <div id="tempLabel" class="text-xs font-mono bg-slate-900 px-2 py-0.5 rounded pill">
                25 °C
              </div>
            </div>
            <input type="range" id="sliderTemp" min="15" max="45" step="1" value="25" />
            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
              <span>Abaixo do ideal</span>
              <span>Estresse térmico forte</span>
            </div>
          </div>

          <!-- Químico -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <div class="text-[10px] uppercase tracking-[0.2em] text-red-400 font-semibold">
                Mistura química (tratamento de semente / tanque)
              </div>
              <div id="chemLabel" class="text-xs font-mono bg-slate-900 px-2 py-0.5 rounded pill">
                Sem químico
              </div>
            </div>
            <div class="grid grid-cols-4 gap-2 text-[11px]">
              <button
                class="chemBtn pill px-2 py-1 border border-slate-700 bg-emerald-500/10 text-emerald-300 font-semibold"
                data-chem="0">Nenhum</button>
              <button class="chemBtn pill px-2 py-1 border border-slate-700 bg-slate-900 text-slate-200"
                data-chem="1">Baixo</button>
              <button class="chemBtn pill px-2 py-1 border border-slate-700 bg-slate-900 text-slate-200"
                data-chem="2">Moderado</button>
              <button class="chemBtn pill px-2 py-1 border border-slate-700 bg-slate-900 text-slate-200"
                data-chem="3">Alto / cúprico</button>
            </div>
          </div>
        </div>

        <!-- Resumo de cenário -->
        <div class="mt-4 border-t border-slate-800 pt-3 text-xs text-slate-400">
          <p id="scenarioSummary"></p>
        </div>
      </section>

      <!-- Gauge + interpretação -->
      <section class="glass rounded-2xl p-5 grid lg:grid-rows-[auto,1fr] gap-4">
        <!-- Gauge + percentual lado a lado -->
        <div class="flex items-center justify-center gap-6">
          <!-- Rosca -->
          <div class="relative w-48 h-48">
            <svg viewBox="0 0 120 120" class="w-full h-full">
              <circle cx="60" cy="60" r="50" class="ring-bg" stroke-width="12" fill="transparent"></circle>
              <circle id="gaugeRing" cx="60" cy="60" r="50" class="ring-fg" stroke-width="12" fill="transparent"
                stroke-dasharray="314" stroke-dashoffset="0" stroke="#22c55e"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-[10px] uppercase tracking-[0.2em] text-slate-400 mb-1">
                Concentração estimada
              </span>
              <div class="flex items-baseline">
                <span class="text-3xl font-mono text-slate-100">
                  10
                </span>
                <span id="logExp" class="text-xl font-mono text-emerald-400 ml-0.5 sup-exp">
                  ¹²
                </span>
              </div>
            </div>
          </div>

          <!-- Percentual grande -->
          <div class="flex flex-col items-start">
            <span class="text-[10px] uppercase tracking-[0.2em] text-slate-400 mb-1">
              Sobrevivência estimada
            </span>
            <div class="flex items-baseline">
              <span id="dosePercent" class="text-5xl font-bold text-slate-50">100</span>
              <span class="ml-1 text-xl text-slate-400">%</span>
            </div>
          </div>
        </div>

        <!-- Texto -->
        <div class="space-y-2">
          <div id="badge"
            class="inline-block px-3 py-1 pill text-[10px] font-semibold uppercase tracking-[0.18em] bg-emerald-500/15 text-emerald-300 border border-emerald-500/40">
            Cenário ideal
          </div>
          <h2 id="title" class="text-xl font-semibold">
            Dose preservada – janela segura
          </h2>
          <p id="desc" class="text-sm text-slate-300">
            Nas condições atuais, a maior parte da dose ainda está ativa.
            O risco de queda logarítmica severa é baixo.
          </p>

          <div class="grid md:grid-cols-2 gap-2 text-[11px] mt-3">
            <div class="bg-slate-900/60 rounded-xl p-3 border border-slate-800">
              <div class="uppercase tracking-[0.18em] text-[10px] text-slate-500 mb-1">
                Leitura rápida
              </div>
              <p id="quickRead" class="text-slate-300 leading-snug">
                Tempo curto, temperatura próxima do ideal e baixa pressão química.
              </p>
            </div>
            <div class="bg-slate-900/60 rounded-xl p-3 border border-slate-800">
              <div class="uppercase tracking-[0.18em] text-[10px] text-slate-500 mb-1">
                Foco de manejo
              </div>
              <p id="managementTip" class="text-slate-300 leading-snug">
                Mantenha essa rotina e priorize testes em pequenas áreas antes de alongar a janela de aplicação.
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Dados dos organismos (modelo simplificado) =====
    const organisms = {
      bacillus: {
        name: "Bacillus (esporos)",
        resilience: 1.5,
        idealTemp: 28,
        logMax: 12,
        logMin: 4,
        quick: "Esporos aguentam bem variações moderadas de tempo e temperatura.",
        manage: "Cuidado maior com misturas químicas muito agressivas; esporos não são indestrutíveis."
      },
      brady: {
        name: "Bradyrhizobium (soja)",
        resilience: 1.0,
        idealTemp: 25,
        logMax: 11,
        logMin: 4,
        quick: "Sensível a calor prolongado e mistura química pesada.",
        manage: "Evite longas horas de tanque. Prefira aplicação no sulco ou TS com janela curta."
      },
      azo: {
        name: "Azospirillum (vegetativa)",
        resilience: 0.6,
        idealTemp: 26,
        logMax: 11,
        logMin: 4,
        quick: "Forma vegetativa é muito vulnerável a calor, dessecação e química.",
        manage: "Use no sulco e minimize tempo de espera. Evite mistura com fungicidas agressivos."
      },
      trichoderma: {
        name: "Trichoderma",
        resilience: 0.8,
        idealTemp: 24,
        logMax: 11,
        logMin: 3,
        quick: "Responde bem em faixa moderada, mas perde vigor em mistura com fungicidas.",
        manage: "Separe aplicações: biofungo em momento diferente da pulverização química principal."
      },
      beauveria: {
        name: "Beauveria bassiana",
        resilience: 0.7,
        idealTemp: 24,
        logMax: 11,
        logMin: 3,
        quick: "Conídios são sensíveis a UV, calor e alguns inseticidas/fungicidas.",
        manage: "Aplicar em horários frescos, evitar sol forte e misturas incompatíveis."
      },
      micorrizas: {
        name: "Micorrizas (AMF)",
        resilience: 0.9,
        idealTemp: 23,
        logMax: 10,
        logMin: 3,
        quick: "Propágulos dependem da raiz viva e sofrem com revolvimento excessivo e química sistêmica.",
        manage: "Priorize aplicação próxima à raiz e reduza fungicidas sistêmicos em fase de colonização."
      },
      pseudomonas: {
        name: "Pseudomonas",
        resilience: 0.5,
        idealTemp: 28,
        logMax: 11,
        logMin: 4,
        quick: "Alta sensibilidade a dessecação e luz UV. Biofilme oferece proteção moderada.",
        manage: "Aplicação noturna ou em dias nublados. Evite mistura com cobre."
      },
      methylobacterium: {
        name: "Methylobacterium",
        resilience: 0.85,
        idealTemp: 28,
        logMax: 11,
        logMin: 4,
        quick: "Pigmentos rosa oferecem proteção UV natural. Resistência moderada a calor.",
        manage: "Compatível com a maioria dos manejos, mas evite pH extremo no tanque."
      },
      pnsb: {
        name: "PNSB (Bactérias Púrpuras)",
        resilience: 0.75,
        idealTemp: 28,
        logMax: 11,
        logMin: 4,
        quick: "Versatilidade metabólica ajuda na sobrevivência, mas requer umidade.",
        manage: "Boa persistência no solo se houver matéria orgânica disponível."
      }
    };

    // ===== Referências de DOM =====
    const timeSlider = document.getElementById("sliderTime");
    const tempSlider = document.getElementById("sliderTemp");
    const chemButtons = document.querySelectorAll(".chemBtn");
    const organismSel = document.getElementById("organismSelect");

    const timeLabel = document.getElementById("timeLabel");
    const tempLabel = document.getElementById("tempLabel");
    const chemLabel = document.getElementById("chemLabel");

    const scenarioSummary = document.getElementById("scenarioSummary");

    const gaugeRing = document.getElementById("gaugeRing");
    const dosePercent = document.getElementById("dosePercent");
    const logExp = document.getElementById("logExp");

    const badge = document.getElementById("badge");
    const titleEl = document.getElementById("title");
    const descEl = document.getElementById("desc");
    const quickReadEl = document.getElementById("quickRead");
    const manageTipEl = document.getElementById("managementTip");

    let currentChem = 0;

    // ===== Interação dos botões de químico =====
    chemButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        currentChem = parseInt(btn.dataset.chem, 10);
        chemButtons.forEach(b => {
          b.classList.remove("bg-emerald-500/10", "text-emerald-300");
          b.classList.add("bg-slate-900", "text-slate-200");
        });
        btn.classList.add("bg-emerald-500/10", "text-emerald-300");
        btn.classList.remove("bg-slate-900", "text-slate-200");
        updateChemLabel();
        updateModel();
      });
    });

    function updateChemLabel() {
      const map = {
        0: "Sem químico",
        1: "Baixa pressão química",
        2: "Mistura moderada",
        3: "Tratamento agressivo / cúprico"
      };
      chemLabel.textContent = map[currentChem] || "Sem químico";
    }

    // ===== Expoente bonitinho 10^x =====
    function formatExp(logN) {
      const exp = Math.round(logN);
      const supMap = {
        "-1": "⁻¹", "0": "⁰", "1": "¹", "2": "²", "3": "³", "4": "⁴",
        "5": "⁵", "6": "⁶", "7": "⁷", "8": "⁸", "9": "⁹", "10": "¹⁰",
        "11": "¹¹", "12": "¹²"
      };
      const s = String(exp);
      return s.split("").map(ch => supMap[ch] || ch).join("");
    }

    // ===== Modelo principal =====
    function updateModel() {
      const orgKey = organismSel.value;
      const org = organisms[orgKey];

      const t = parseInt(timeSlider.value, 10);
      const temp = parseInt(tempSlider.value, 10);
      const chem = currentChem;

      timeLabel.textContent = `${t} h`;
      tempLabel.textContent = `${temp} °C`;

      // Normalizações simples 0–1
      const timeStress = t / 24;
      let tempStress = 0;
      if (temp > org.idealTemp) {
        tempStress = Math.min(1, (temp - org.idealTemp) / 15);
      } else {
        tempStress = Math.min(1, (org.idealTemp - temp) / 20) * 0.5;
      }
      const chemStress = chem / 3;

      const rawStress = (timeStress + tempStress + chemStress) / 3;

      // Ajuste por resiliência
      let effStress = rawStress / org.resilience;
      effStress = Math.max(0, Math.min(1, effStress));

      // Log de população: interpolação entre logMax e logMin
      const span = org.logMax - org.logMin;
      const logN = org.logMax - span * effStress;

      // Percentual de janela de dose (0–100% relativo ao range logMin–logMax)
      const doseNorm = ((logN - org.logMin) / span) * 100;
      const doseClamped = Math.max(0, Math.min(100, doseNorm));

      // Rosca (usa doseClamped real)
      const circ = 2 * Math.PI * 50;
      const offset = circ * (1 - doseClamped / 100);
      gaugeRing.style.strokeDasharray = String(circ);
      gaugeRing.style.strokeDashoffset = String(offset);

      // Exibição: se ainda está na janela (≥ logMin), nunca mostrar menos que 1%
      const displayPct = Math.max(1, Math.round(doseClamped));
      dosePercent.textContent = displayPct;

      // Cor e cenário
      let scenario, badgeText, badgeClasses, titleText, descText;
      if (effStress < 0.3) {
        scenario = "ideal";
        gaugeRing.setAttribute("stroke", "#22c55e");
        badgeText = "Cenário ideal";
        badgeClasses = "bg-emerald-500/15 text-emerald-300 border border-emerald-500/40";
        titleText = "Dose preservada – janela segura";
        descText = "Perdas logarítmicas ainda pequenas. Janela de decisão confortável para a operação.";
      } else if (effStress < 0.7) {
        scenario = "moderado";
        gaugeRing.setAttribute("stroke", "#eab308");
        badgeText = "Cenário intermediário";
        badgeClasses = "bg-amber-500/15 text-amber-300 border border-amber-500/40";
        titleText = "Zona de atenção – janela encurtando";
        descText = "A dose ainda é aproveitável, mas a combinação de tempo, temperatura e química já exige ajustes finos.";
      } else {
        scenario = "extremo";
        gaugeRing.setAttribute("stroke", "#ef4444");
        badgeText = "Cenário extremo";
        badgeClasses = "bg-red-500/15 text-red-300 border border-red-500/40";
        titleText = "Risco alto de perda logarítmica";
        descText = "Grande parte da dose já foi comprometida. É provável que a resposta a campo seja inconsistente.";
      }

      badge.textContent = badgeText;
      badge.className =
        "inline-block px-3 py-1 pill text-[10px] font-semibold uppercase tracking-[0.18em] " +
        badgeClasses;
      titleEl.textContent = titleText;
      descEl.textContent = descText;

      // Expoente 10^x
      logExp.innerHTML = formatExp(logN);

      // Texto de cenário e manejo
      const scenarioText = {
        ideal: "Tempo curto, temperatura próxima do ideal e pressão química baixa. Esse é o cenário-alvo para validação em campo.",
        moderado: "Um dos fatores já está puxando o sistema para fora da zona de conforto. A resposta ainda pode ser boa, mas menos previsível.",
        extremo: "Tempo longo, calor, mistura química agressiva ou combinação desses fatores. Aqui a chance de frustração é alta."
      };

      scenarioSummary.textContent = scenarioText[scenario];
      quickReadEl.textContent = org.quick;
      manageTipEl.textContent = org.manage;

      // Notifica o pai (Lab / Wiki) – para integração futura
      notifyParent(orgKey, rawStress);
    }

    // Eventos básicos
    timeSlider.addEventListener("input", updateModel);
    tempSlider.addEventListener("input", updateModel);
    organismSel.addEventListener("change", updateModel);

    // ===== Comunicação com o pai (iframe) =====
    function notifyParent(orgKey, stress) {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: "simulatorChange",
          payload: {
            organismKey: orgKey,
            stressProxy: stress
          }
        }, "*");
      }
    }

    // Listener para mensagens vindas do Lab (clicou na bolha → sincroniza simulador)
    window.addEventListener("message", (event) => {
      if (!event.data || typeof event.data !== "object") return;
      if (event.data.type !== "labSelection") return;

      const payload = event.data.payload || {};
      const orgKey = payload.organismKey;
      const stress = typeof payload.stress === "number" ? payload.stress : 0;

      // Atualiza organismo, se existir na lista
      if (orgKey && Array.from(organismSel.options).some(o => o.value === orgKey)) {
        organismSel.value = orgKey;
      }

      // Heurística: mapeia stress (0–1) para ranges dos sliders
      const timeMin = parseInt(timeSlider.min);
      const timeMax = parseInt(timeSlider.max);
      timeSlider.value = Math.round(timeMin + (timeMax - timeMin) * stress);

      const tempMin = parseInt(tempSlider.min);
      const tempMax = parseInt(tempSlider.max);
      const org = organisms[orgKey] || organisms["bacillus"];
      const ideal = org.idealTemp;
      let targetTemp = ideal + (stress * 15);
      if (targetTemp > tempMax) targetTemp = tempMax;
      if (targetTemp < tempMin) targetTemp = tempMin;
      tempSlider.value = Math.round(targetTemp);

      updateModel();
    });

    // Estado inicial
    updateChemLabel();
    updateModel();
  </script>
</body>

</html>