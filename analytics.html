<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioHub Analytics - Dashboard Final</title>

    <script src="lib/tailwindcss.min.js"></script>
    <script src="lib/d3.v7.min.js"></script>
    <script src="lib/d3-sankey.min.js"></script>

    <link rel="stylesheet" href="css/all.min.css">
    <!-- opcional: <link rel="stylesheet" href="css/fonts.css"> -->

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        bio: {
                            dark: '#050816',
                            accent: '#0ea5e9',
                            leaf: '#22c55e',
                            soil: '#f97316',
                            purple: '#d946ef',
                            red: '#ef4444',
                            gold: '#eab308'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS BASE */
        body {
            background-color: #050816;
            color: #cbd5e1;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ESTILOS LIGHT MODE */
        html.light-mode body {
            background-color: #f1f5f9;
            color: #334155;
        }

        /* Barra e Painéis no Light Mode */
        html.light-mode .glass-bar {
            background: rgba(255, 255, 255, 0.95) !important;
            border-bottom: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05) !important;
        }

        html.light-mode .glass-panel {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05) !important;
        }

        /* Ajuste da Caixa de Status no Light Mode */
        html.light-mode #sankey-status {
            background-color: #f8fafc !important;
            border-left-width: 4px !important;
            border-color: #e2e8f0 !important;
        }

        html.light-mode #sankey-status-desc {
            color: #64748b !important;
        }

        html.light-mode #sankey-icon-box {
            background-color: #e2e8f0 !important;
            color: #475569 !important;
        }

        /* Textos no Light Mode */
        html.light-mode h3,
        html.light-mode h4,
        html.light-mode strong {
            color: #0f172a !important;
        }

        html.light-mode p,
        html.light-mode .text-gray-400 {
            color: #475569 !important;
        }

        /* ESTILOS DARK MODE (PADRÃO) */
        .glass-bar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
        }

        .d3-tooltip {
            position: absolute;
            text-align: left;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #334155;
            border-radius: 6px;
            pointer-events: none;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 1000;
            white-space: nowrap;
        }

        /* Scrollbar Personalizada para Containers */
        .scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(150, 150, 150, 0.3);
            border-radius: 10px;
        }
    </style>
</head>

<body class="antialiased">

    <div class="sticky top-0 z-50 glass-bar w-full py-4 px-6 transition-all duration-300" id="info-bar">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-5 w-full md:w-1/3 border-r border-gray-500/20 pr-6">
                <div class="p-3 bg-bio-accent/10 rounded-xl border border-bio-accent/20 text-bio-accent text-2xl shadow-[0_0_15px_rgba(14,165,233,0.2)]"
                    id="bar-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div>
                    <h4 id="bar-title"
                        class="text-white font-display font-bold text-lg uppercase tracking-tight leading-none mb-1">
                        BioHub Analytics</h4>
                    <div class="flex items-center gap-2">
                        <span class="text-bio-accent font-bold text-xs uppercase tracking-widest"
                            id="bar-subtitle">MATRIZ DE RESILIÊNCIA</span>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-2/3">
                <p id="bar-desc"
                    class="text-gray-400 text-sm md:text-base leading-relaxed font-light transition-all duration-300">
                    Interaja com a Matriz abaixo para ver detalhes moleculares. Role para baixo para ver o Fluxo Lógico.
                </p>
            </div>
        </div>
    </div>

    <section class="min-h-screen py-8 relative">
        <div
            class="absolute top-0 left-1/4 w-[1000px] h-[500px] bg-bio-accent/5 rounded-full blur-[120px] pointer-events-none mix-blend-screen">
        </div>

        <div class="container mx-auto px-4 md:px-8 relative z-10 flex flex-col gap-8">

            <div class="glass-panel rounded-2xl p-4 animate-fade-in-up">
                <div class="flex justify-between items-center mb-1 border-b border-gray-500/20 pb-2 px-2">
                    <h3 class="text-white font-bold text-lg flex items-center gap-2 font-display">
                        <i class="fas fa-th text-bio-purple"></i> Matriz de Resiliência
                    </h3>
                    <div class="flex gap-4 text-[9px] uppercase tracking-widest text-gray-400 font-bold hidden md:flex">
                        <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-bio-red"></span>
                            Colapso</div>
                        <div class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-bio-gold"></span>
                            Estresse</div>
                        <div class="flex items-center gap-1"><span
                                class="w-2 h-2 rounded-full bg-bio-leaf shadow-[0_0_6px_#22c55e]"></span> Ótimo</div>
                    </div>
                </div>
                <div class="text-[10px] text-gray-500 md:hidden mb-2 text-center italic">Arraste para o lado para ver
                    toda a tabela &rarr;</div>
                <div class="w-full h-[420px] scroll-container" id="heatmap-wrapper">
                    <div id="heatmap-container"></div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4 animate-fade-in-up" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-center mb-4 border-b border-gray-500/20 pb-2 px-2">
                    <h3 class="text-white font-bold text-lg flex items-center gap-2 font-display">
                        <i class="fas fa-random text-bio-leaf"></i> Fluxo de Solução
                    </h3>
                    <span
                        class="text-[10px] text-gray-500 font-mono bg-white/5 border border-white/10 px-2 py-1 rounded">INPUT
                        &rarr; BIO &rarr; OUTPUT</span>
                </div>

                <div id="sankey-status"
                    class="mb-4 p-4 rounded-xl bg-black/20 border-l-4 border-bio-leaf flex items-start gap-4 transition-all duration-300 min-h-[80px]">
                    <div class="p-2 bg-white/5 rounded-lg text-gray-400 shrink-0" id="sankey-icon-box">
                        <i class="fas fa-mouse-pointer text-xl"></i>
                    </div>
                    <div>
                        <h4 id="sankey-status-title" class="text-white font-bold text-sm uppercase tracking-wide mb-1">
                            Interaja com o Diagrama</h4>
                        <p id="sankey-status-desc" class="text-gray-400 text-sm leading-snug">
                            Passe o mouse sobre os nós ou conexões para visualizar o mecanismo de ação específico.
                        </p>
                    </div>
                </div>
                <div id="sankey-container" class="w-full min-h-[500px]"></div>
            </div>
        </div>

        <div id="tooltip" class="d3-tooltip opacity-0"></div>
    </section>

    <script>
        // ======================================================
        // 1. DADOS (DATA)
        // ======================================================

        const heatmapData = [
            { row: "BACILLUS", col: "ALTA TEMP (>45°C)", val: 9, mech: "Esporulação", desc: "Endósporos termoestáveis permitem sobrevivência acima de 45°C sem perda de viabilidade." },
            { row: "BACILLUS", col: "SECA SEVERA", val: 9, mech: "Dormência", desc: "Entra em estado de dormência metabólica total via esporulação." },
            { row: "BACILLUS", col: "PH ÁCIDO (<5.0)", val: 6, mech: "Biofilme", desc: "Tolerância moderada protegida por matriz exopolimérica." },
            { row: "BACILLUS", col: "BAIXO P (SOLO)", val: 9, mech: "PQQ-GDH", desc: "Alta eficiência na produção de Ácido Glucônico via PQQ-GDH." },
            { row: "BACILLUS", col: "FUNGICIDAS TS", val: 6, mech: "Degradação", desc: "Capacidade enzimática de degradar certos ativos químicos." },
            { row: "BACILLUS", col: "SALINIDADE", val: 8, mech: "Osmólitos", desc: "Acúmulo de prolina mantém turgor celular." },
            { row: "BACILLUS", col: "ALTO N", val: 9, mech: "Indiferente", desc: "Não sofre feedback negativo por nitrogênio mineral." },
            { row: "BACILLUS", col: "COMPETIÇÃO", val: 8, mech: "Antibióticos", desc: "Secreta lipopeptídeos (Iturinas) que eliminam competidores." },
            { row: "BACILLUS", col: "COMPACTAÇÃO", val: 7, mech: "EPS", desc: "EPS ajuda na agregação e estruturação do solo." },
            { row: "BACILLUS", col: "METAIS TÓXICOS", val: 7, mech: "Bioacumulação", desc: "Parede celular sequestra metais pesados." },

            { row: "PSEUDOMONAS", col: "ALTA TEMP (>45°C)", val: 2, mech: "Lise Celular", desc: "Células vegetativas morrem rapidamente >35°C." },
            { row: "PSEUDOMONAS", col: "SECA SEVERA", val: 3, mech: "Dessecação", desc: "Motilidade depende de filme de água contínuo." },
            { row: "PSEUDOMONAS", col: "PH ÁCIDO (<5.0)", val: 5, mech: "Inibição", desc: "Síntese de Pioverdina reduzida em pH baixo." },
            { row: "PSEUDOMONAS", col: "BAIXO P (SOLO)", val: 10, mech: "Ácidos Org.", desc: "Solubilizador mais rápido e agressivo da rizosfera." },
            { row: "PSEUDOMONAS", col: "FUNGICIDAS TS", val: 1, mech: "Mortal", desc: "Membrana externa exposta. Incompatível." },
            { row: "PSEUDOMONAS", col: "SALINIDADE", val: 4, mech: "Estresse", desc: "Choque osmótico prejudica divisão celular." },
            { row: "PSEUDOMONAS", col: "ALTO N", val: 8, mech: "Sinergia", desc: "Funciona bem em sistemas de alta tecnologia." },
            { row: "PSEUDOMONAS", col: "COMPETIÇÃO", val: 9, mech: "Sideróforos", desc: "Domina a competição por ferro." },
            { row: "PSEUDOMONAS", col: "COMPACTAÇÃO", val: 3, mech: "Anaerobiose", desc: "Aeróbia estrita. Sofre sem oxigênio." },
            { row: "PSEUDOMONAS", col: "METAIS TÓXICOS", val: 6, mech: "Efluxo", desc: "Bombas de efluxo conferem resistência moderada." },

            { row: "AZOSPIRILLUM", col: "ALTA TEMP (>45°C)", val: 5, mech: "Cistos", desc: "Cistos oferecem resistência média." },
            { row: "AZOSPIRILLUM", col: "SECA SEVERA", val: 7, mech: "Trehalose", desc: "Acúmulo de trehalose previne colapso." },
            { row: "AZOSPIRILLUM", col: "PH ÁCIDO (<5.0)", val: 6, mech: "Adaptação", desc: "Estirpes selecionadas para Cerrado." },
            { row: "AZOSPIRILLUM", col: "BAIXO P (SOLO)", val: 4, mech: "Indireto", desc: "Estimula raízes para buscar P." },
            { row: "AZOSPIRILLUM", col: "FUNGICIDAS TS", val: 3, mech: "Sensível", desc: "Mortalidade alta em contato direto." },
            { row: "AZOSPIRILLUM", col: "SALINIDADE", val: 7, mech: "ACC Desam.", desc: "Quebra etileno de estresse." },
            { row: "AZOSPIRILLUM", col: "ALTO N", val: 2, mech: "Inibição", desc: "Nitrogenase inibida por amônio." },
            { row: "AZOSPIRILLUM", col: "COMPETIÇÃO", val: 4, mech: "Lento", desc: "Crescimento mais lento que Pseudomonas." },
            { row: "AZOSPIRILLUM", col: "COMPACTAÇÃO", val: 6, mech: "Microaerófilo", desc: "Tolera baixos níveis de oxigênio." },
            { row: "AZOSPIRILLUM", col: "METAIS TÓXICOS", val: 5, mech: "Variável", desc: "Resistência varia entre estirpes." },

            { row: "BRADYRHIZOBIUM", col: "ALTA TEMP (>45°C)", val: 3, mech: "Perda pSym", desc: "Risco de perder plasmídeo simbiótico." },
            { row: "BRADYRHIZOBIUM", col: "SECA SEVERA", val: 5, mech: "Muco", desc: "EPS protege, mas infecção falha." },
            { row: "BRADYRHIZOBIUM", col: "PH ÁCIDO (<5.0)", val: 8, mech: "Evolução", desc: "Adaptado a solos ácidos tropicais." },
            { row: "BRADYRHIZOBIUM", col: "BAIXO P (SOLO)", val: 3, mech: "Dependente", desc: "Nodulação exige fósforo da planta." },
            { row: "BRADYRHIZOBIUM", col: "FUNGICIDAS TS", val: 4, mech: "Protetor", desc: "Exige inoculante turfoso." },
            { row: "BRADYRHIZOBIUM", col: "SALINIDADE", val: 5, mech: "Falha Infec.", desc: "Afeta deformação do pêlo radicular." },
            { row: "BRADYRHIZOBIUM", col: "ALTO N", val: 1, mech: "Aborto", desc: "Planta bloqueia nodulação com nitrato." },
            { row: "BRADYRHIZOBIUM", col: "COMPETIÇÃO", val: 2, mech: "Crítico", desc: "Requer doses massivas (10^9)." },
            { row: "BRADYRHIZOBIUM", col: "COMPACTAÇÃO", val: 4, mech: "Hipóxia", desc: "Bacteroides exigem fluxo de O2." },
            { row: "BRADYRHIZOBIUM", col: "METAIS TÓXICOS", val: 3, mech: "Sensível", desc: "Nodulação inibida precocemente." },
        ];

        const logicFlows = [
            { input: "s1", agent: "a1", output: "o1", desc: "Bacillus produz Biofilme/EPS para agregar o solo." },
            { input: "s1", agent: "a5", output: "o1", desc: "Azospirillum produz EPS nas raízes para microambientes." },
            { input: "s2", agent: "a2", output: "o2", desc: "Pseudomonas produz ácido glucônico massivo para solubilização." },
            { input: "s2", agent: "a1", output: "o2", desc: "Bacillus solubiliza fosfatos via PQQ-GDH." },
            { input: "s3", agent: "a3", output: "o3", desc: "Trichoderma realiza micoparasitismo direto e lise." },
            { input: "s3", agent: "a1", output: "o3", desc: "Bacillus secreta Iturinas (antibióticos)." },
            { input: "s3", agent: "a2", output: "o3", desc: "Pseudomonas priva patógenos de ferro (Sideróforos)." },
            { input: "s3", agent: "a2", output: "o6", desc: "Pseudomonas ativa ISR (imunidade sistêmica)." },
            { input: "s4", agent: "a4", output: "o4", desc: "Bradyrhizobium fixa N simbiótico em nódulos." },
            { input: "s4", agent: "a5", output: "o4", desc: "Azospirillum fixa N associativo (menor taxa)." },
            { input: "s5", agent: "a5", output: "o5", desc: "Azospirillum quebra etileno de estresse (ACC Desaminase)." },
            { input: "s5", agent: "a1", output: "o1", desc: "Bacillus forma biofilme para reter umidade." }
        ];

        const sankeyNodesDef = [
            { id: "s1", name: "Solo Compactado", col: 0, color: "#ef4444" },
            { id: "s2", name: "Baixo Fósforo", col: 0, color: "#f97316" },
            { id: "s3", name: "Patógenos", col: 0, color: "#d946ef" },
            { id: "s4", name: "Deficiência N", col: 0, color: "#eab308" },
            { id: "s5", name: "Salinidade/Seca", col: 0, color: "#ef4444" },

            { id: "a1", name: "Bacillus", col: 1, color: "#0ea5e9" },
            { id: "a2", name: "Pseudomonas", col: 1, color: "#8b5cf6" },
            { id: "a3", name: "Trichoderma", col: 1, color: "#fbbf24" },
            { id: "a4", name: "Bradyrhizobium", col: 1, color: "#22c55e" },
            { id: "a5", name: "Azospirillum", col: 1, color: "#10b981" },

            { id: "o1", name: "Biofilme (EPS)", col: 2, color: "#64748b" },
            { id: "o2", name: "Solubilização", col: 2, color: "#f97316" },
            { id: "o3", name: "Antibiose", col: 2, color: "#d946ef" },
            { id: "o4", name: "FBN (Nitrogenase)", col: 2, color: "#22c55e" },
            { id: "o5", name: "ACC Desaminase", col: 2, color: "#ef4444" },
            { id: "o6", name: "ISR (Imunidade)", col: 2, color: "#8b5cf6" }
        ];

        // ======================================================
        // 2. FUNÇÕES UI
        // ======================================================

        function updateInfoBar(title, desc, color, iconClass) {
            document.getElementById("bar-title").innerText = title;
            document.getElementById("bar-title").style.color = color;
            document.getElementById("bar-subtitle").innerText = "Detalhe Bioquímico";
            document.getElementById("bar-subtitle").style.color = color;
            document.getElementById("bar-desc").innerHTML = desc;

            const iconContainer = document.getElementById("bar-icon");
            iconContainer.innerHTML = `<i class="${iconClass}"></i>`;
            iconContainer.style.color = color;
            iconContainer.style.borderColor = color;
            iconContainer.style.backgroundColor = color + '1A';
        }

        function updateSankeyInfo(title, desc, color, iconClass) {
            const box = document.getElementById("sankey-status");
            const titleEl = document.getElementById("sankey-status-title");
            const descEl = document.getElementById("sankey-status-desc");
            const iconBox = document.getElementById("sankey-icon-box");

            if (document.documentElement.classList.contains('light-mode')) {
                box.style.borderLeftColor = color;
            } else {
                box.style.borderLeftColor = color;
            }
            iconBox.style.color = color;
            iconBox.innerHTML = `<i class="${iconClass} text-xl"></i>`;

            titleEl.innerText = title;
            titleEl.style.color = color;
            descEl.innerHTML = desc;
        }

        const tooltip = document.getElementById('tooltip');
        const showTooltip = (e, html) => {
            tooltip.innerHTML = html; tooltip.style.opacity = 1;
            tooltip.style.left = e.pageX + 15 + 'px'; tooltip.style.top = e.pageY + 15 + 'px';
        };
        const hideTooltip = () => { tooltip.style.opacity = 0; };

        // ======================================================
        // 3. RENDER HEATMAP (Com Scroll no Mobile)
        // ======================================================
        function renderHeatmap() {
            const wrapper = document.getElementById("heatmap-wrapper");
            const container = document.getElementById("heatmap-container");
            if (!container || !wrapper) return;
            container.innerHTML = "";

            const isLight = document.documentElement.classList.contains('light-mode');
            const textColor = isLight ? '#1e293b' : '#fff';
            const axisColor = isLight ? '#64748b' : '#94a3b8';
            const gridColor = isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.03)';

            const isMobile = window.innerWidth < 768;
            let computedWidth = wrapper.clientWidth || window.innerWidth - 40;
            const minWidth = isMobile ? 600 : computedWidth;

            const margin = { top: 120, right: 20, bottom: 20, left: 140 };
            const width = minWidth - margin.left - margin.right;
            const height = (wrapper.clientHeight || 420) - margin.top - margin.bottom;

            const svg = d3.select("#heatmap-container").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const rows = [...new Set(heatmapData.map(d => d.row))];
            const cols = [...new Set(heatmapData.map(d => d.col))];

            const x = d3.scaleBand().range([0, width]).domain(cols).padding(0.05);
            const y = d3.scaleBand().range([0, height]).domain(rows).padding(0.2);

            svg.selectAll("path.grid").data(cols).enter().append("line")
                .attr("x1", d => x(d) + x.bandwidth() / 2).attr("x2", d => x(d) + x.bandwidth() / 2)
                .attr("y1", 0).attr("y2", height)
                .attr("stroke", gridColor).attr("stroke-width", 1).attr("stroke-dasharray", "3,3");

            const yAxis = svg.append("g").attr("class", "y-axis").call(d3.axisLeft(y).tickSize(0));
            yAxis.select(".domain").remove();
            yAxis.selectAll(".tick text").attr("fill", textColor).style("font-size", "12px").style("font-weight", "700").style("font-family", "Inter").style("text-anchor", "end").attr("dx", "-10");

            const xAxis = svg.append("g").attr("class", "x-axis").call(d3.axisTop(x).tickSize(0));
            xAxis.select(".domain").remove();
            xAxis.selectAll(".tick text").attr("transform", "rotate(-90)").attr("dy", "0.35em").attr("dx", "10").style("text-anchor", "start").style("fill", axisColor).style("font-family", "Space Grotesk").style("font-size", "10px").style("font-weight", "600");

            const colorScale = d3.scaleLinear().domain([1, 5, 9]).range(["#ef4444", "#eab308", "#22c55e"]);

            svg.selectAll()
                .data(heatmapData).enter().append("circle")
                .attr("cx", d => x(d.col) + x.bandwidth() / 2)
                .attr("cy", d => y(d.row) + y.bandwidth() / 2)
                .attr("r", 0)
                .style("fill", d => colorScale(d.val)).style("fill-opacity", 0.8)
                .style("stroke", d => colorScale(d.val)).style("stroke-width", 1)
                .style("cursor", "pointer")
                .on("mouseover", function (event, d) {
                    d3.select(this).transition().duration(150).attr("r", Math.min(x.bandwidth(), y.bandwidth()) / 1.5).style("fill-opacity", 1).style("stroke", textColor).style("stroke-width", 2);
                    updateInfoBar(`${d.row} vs ${d.col}`, d.desc, colorScale(d.val), "fas fa-microscope");
                    showTooltip(event, `Score: ${d.val}/10 • ${d.mech}`);
                })
                .on("mouseout", function (event, d) {
                    d3.select(this).transition().duration(250).attr("r", d.val * 1.3 + 3).style("fill-opacity", 0.8).style("stroke-width", 1).style("stroke", d => colorScale(d.val));
                    hideTooltip();
                })
                .transition().duration(800).delay((d, i) => i * 8).attr("r", d => d.val * 1.3 + 3);
        }

        // ======================================================
        // 4. RENDER SANKEY (Vertical no Mobile, Horizontal no Desktop)
        // ======================================================
        function renderManualSankey() {
            const container = document.getElementById("sankey-container");
            if (!container) return;
            container.innerHTML = "";

            // Threshold para Mobile (Vertical) - GARANTE O VERTICAL NO CELULAR
            const isMobile = window.innerWidth < 1024;

            const width = container.clientWidth || window.innerWidth - 40;
            const height = isMobile ? 800 : 500;
            container.style.height = height + "px";

            const isLight = document.documentElement.classList.contains('light-mode');
            const textFill = isLight ? '#1e293b' : '#fff';
            const nodeStroke = isLight ? '#cbd5e1' : '#fff';

            const svg = d3.select("#sankey-container").append("svg").attr("width", width).attr("height", height);

            const cols = [[], [], []];
            sankeyNodesDef.forEach(n => cols[n.col].push(n));

            // CORRIGIDO AQUI: Margem 140px no Desktop para não cortar o texto
            const paddingMain = isMobile ? 60 : 140;
            const laneSize = isMobile ? height : width;
            const lanePositions = [paddingMain, laneSize / 2, laneSize - paddingMain];

            cols.forEach((nodesInGroup, groupIndex) => {
                const crossSize = isMobile ? width : height;
                const spacing = crossSize / (nodesInGroup.length + 1);
                nodesInGroup.forEach((node, i) => {
                    if (isMobile) {
                        node.x = spacing * (i + 1);
                        node.y = lanePositions[groupIndex];
                    } else {
                        node.x = lanePositions[groupIndex];
                        node.y = spacing * (i + 1);
                    }
                });
            });

            const linksToDraw = [];
            logicFlows.forEach((flow, index) => {
                const nodeIn = sankeyNodesDef.find(n => n.id === flow.input);
                const nodeAg = sankeyNodesDef.find(n => n.id === flow.agent);
                const nodeOut = sankeyNodesDef.find(n => n.id === flow.output);
                linksToDraw.push({ source: nodeIn, target: nodeAg, flowId: index, desc: flow.desc, color: nodeIn.color, width: 6 });
                linksToDraw.push({ source: nodeAg, target: nodeOut, flowId: index, desc: flow.desc, color: nodeIn.color, width: 6 });
            });

            let linkGen;
            if (isMobile) {
                linkGen = d3.linkVertical().source(d => [d.source.x, d.source.y + 10]).target(d => [d.target.x, d.target.y - 10]);
            } else {
                linkGen = d3.linkHorizontal().source(d => [d.source.x + 15, d.source.y]).target(d => [d.target.x - 15, d.target.y]);
            }

            const linkSelection = svg.selectAll("path.link")
                .data(linksToDraw).enter().append("path")
                .attr("class", "link")
                .attr("d", linkGen)
                .attr("fill", "none")
                .attr("stroke", d => d.color)
                .attr("stroke-width", d => d.width)
                .attr("stroke-opacity", 0.15)
                .style("transition", "all 0.3s")
                .style("cursor", "pointer");

            const nodeSelection = svg.selectAll("g.node")
                .data(sankeyNodesDef).enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .style("cursor", "pointer");

            nodeSelection.append("circle")
                .attr("r", 7).attr("fill", d => d.color).attr("stroke", nodeStroke).attr("stroke-width", 2);

            const text = nodeSelection.append("text")
                .text(d => d.name)
                .attr("fill", textFill)
                .style("font-size", isMobile ? "10px" : "11px") // Fonte menor no mobile
                .style("font-weight", "700").style("font-family", "Inter").style("pointer-events", "none")
                .style("text-shadow", isLight ? "none" : "0 2px 4px rgba(0,0,0,0.8)");

            if (isMobile) {
                // *** Lógica VERTICAL (Mobile) com ROTAÇÃO ***
                text.attr("text-anchor", "start")
                    .attr("transform", d => {
                        // Topo e Meio: Rotação -45 (Sobe p/ direita)
                        if (d.col !== 2) {
                            return `rotate(-45) translate(8, -3)`;
                        }
                        // Fundo (Output): Rotação 45 (Desce p/ direita)
                        else {
                            return `rotate(45) translate(8, 3)`;
                        }
                    });
            } else {
                // *** Lógica HORIZONTAL (Desktop) - RESTAURADA ***
                text
                    .attr("dy", "0.35em")
                    .attr("x", d => d.col === 2 ? 15 : (d.col === 0 ? -15 : 0))
                    .attr("y", d => d.col === 1 ? -15 : 0) // Ajuste fino central
                    .attr("text-anchor", d => d.col === 2 ? "start" : (d.col === 0 ? "end" : "middle"));
            }

            // Interatividade
            linkSelection.on("mouseover", function (e, d) { highlightFlow(d.flowId, d.desc, d.color); }).on("mouseout", resetHighlight);
            nodeSelection.on("mouseover", function (e, d) {
                const flowsInvolved = logicFlows.map((flow, idx) => ({ ...flow, id: idx })).filter(flow => flow.input === d.id || flow.agent === d.id || flow.output === d.id);
                const activeFlowIds = flowsInvolved.map(f => f.id);
                linkSelection.attr("stroke-opacity", l => activeFlowIds.includes(l.flowId) ? 0.8 : 0.05).attr("stroke-width", l => activeFlowIds.includes(l.flowId) ? l.width + 3 : l.width);
                let descText = d.col === 0 ? `Problema Inicial. Afeta ${flowsInvolved.length} vias biológicas.` : (d.col === 1 ? `Agente Central.` : `Mecanismo Resultante.`);
                updateSankeyInfo(d.name, descText, d.color, "fas fa-circle");
            }).on("mouseout", resetHighlight);

            function highlightFlow(flowId, desc, color) {
                linkSelection.attr("stroke-opacity", 0.05).filter(l => l.flowId === flowId).attr("stroke-opacity", 0.9).attr("stroke-width", l => l.width + 4);
                updateSankeyInfo("Fluxo Lógico Ativado", desc, color, "fas fa-project-diagram");
            }

            function resetHighlight() {
                linkSelection.attr("stroke-opacity", 0.15).attr("stroke-width", l => l.width);
                const isLight = document.documentElement.classList.contains('light-mode');
                const defColor = isLight ? '#10b981' : '#22c55e';
                updateSankeyInfo("Interaja com o Diagrama", "Passe o mouse sobre os nós...", defColor, "fas fa-mouse-pointer");
            }
        }

        // THEME SYNC & RESIZE
        window.addEventListener('message', (event) => {
            const html = document.documentElement;
            let shouldRender = false;

            if (event.data === 'toggle-theme') {
                html.classList.toggle('light-mode');
                if (html.classList.contains('light-mode')) { html.classList.remove('dark'); } else { html.classList.add('dark'); }
                shouldRender = true;
            }

            if (event.data === 'force-light') {
                if (!html.classList.contains('light-mode')) {
                    html.classList.add('light-mode');
                    html.classList.remove('dark');
                    shouldRender = true;
                }
            }

            if (shouldRender) {
                renderHeatmap();
                renderManualSankey();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            try {
                if (window.parent && window.parent.document.documentElement.classList.contains('light-mode')) {
                    document.documentElement.classList.add('light-mode');
                }
            } catch (e) { }
            setTimeout(() => { renderHeatmap(); renderManualSankey(); }, 300);
        });

        window.addEventListener("resize", () => { renderHeatmap(); renderManualSankey(); });
    </script>
</body>

</html>